<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="es"
      layout:decorate="~{layout}">

<head>
    <title>Productos</title>
</head>
<body>
<div layout:fragment="contenido" class="relative">

    <h1 class="text-3xl font-bold text-gray-800">Gestión de Productos</h1>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Flash messages -->
    <div th:if="${success}">
        <script th:inline="javascript">
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: [[${success}]],
                confirmButtonColor: '#2563eb'
            });
        </script>
    </div>
    <div th:if="${error}">
        <script th:inline="javascript">
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: [[${error}]],
                confirmButtonColor: '#dc2626'
            });
        </script>
    </div>

    <!-- Controles -->
    <div class="flex flex-col md:flex-row justify-between items-center mt-6 mb-4 gap-3">
        <!-- Buscador -->
        <form th:action="@{/productos}" method="get" class="flex w-full md:w-1/2 space-x-2">
            <input type="text" name="keyword" th:value="${keyword}"
                   placeholder="Buscar producto por nombre o categoría"
                   class="flex-1 border rounded px-3 py-2"/>
            <button type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Buscar
            </button>
        </form>

        <!-- Botón Nuevo -->
        <button id="btnNuevoProducto" type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
            + Nuevo Producto
        </button>
    </div>


    <!-- Tabla (desktop) -->
    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-100 text-gray-700 uppercase">
            <tr>
                <th class="px-4 py-3">ID</th>
                <th class="px-4 py-3">Nombre</th>
                <th class="px-4 py-3">Precio</th>
                <th class="px-4 py-3">Stock</th>
                <th class="px-4 py-3">Categoría</th>
                <th class="px-4 py-3">Proveedor</th>
                <th class="px-4 py-3 text-center">Acciones</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" th:each="prod : ${productosPage.content}">
            <tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-3" th:text="${prod.id}">1</td>
                <td class="px-4 py-3" th:text="${prod.nombre}">Producto</td>
                <td class="px-4 py-3" th:text="${prod.precio}">10.00</td>
                <td class="px-4 py-3" th:text="${prod.stock}">100</td>
                <td class="px-4 py-3" th:text="${prod.categoria}">BEBIDA</td>
                <td class="px-4 py-3" th:text="${prod.proveedor.nombre}">Proveedor A</td>
                <td class="px-4 py-3 text-center space-x-2">
                    <!-- Botón Editar -->
                    <button type="button"
                            class="btnEditar bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                            th:attr="data-id=${prod.id},
                                     data-nombre=${prod.nombre},
                                     data-precio=${prod.precio},
                                     data-stock=${prod.stock},
                                     data-categoria=${prod.categoria},
                                     data-proveedor=${prod.proveedor.id}">
                        Editar
                    </button>

                    <!-- Eliminar -->
                    <form th:action="@{/productos/eliminar/{id}(id=${prod.id})}" method="post"
                          class="inline eliminar-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                            Eliminar
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>


    </div>


    <!-- Paginación Desktop-->

    <div class="hidden md:flex mt-4 justify-center space-x-2">
        <a th:each="i : ${#numbers.sequence(0, productosPage.totalPages - 1)}"
           th:href="@{/productos(page=${i}, keyword=${keyword})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage}
           ? 'bg-blue-600 text-white px-3 py-1 rounded'
           : 'bg-gray-200 px-3 py-1 rounded hover:bg-gray-300'">
        </a>
    </div>

    <!--Modales -->

    <!-- Modal: Registrar -->
    <div id="modalRegistro" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-lg p-6"><h2 class="text-xl font-bold mb-4">Registrar Producto</h2>
            <form th:action="@{/productos/registrar}" th:object="${nuevoProducto}" method="post" class="space-y-4">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div><label class="block text-sm font-medium">Nombre *</label> <input th:field="*{nombre}" type="text"
                                                                                      maxlength="100" required
                                                                                      class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Precio *</label> <input th:field="*{precio}" type="number"
                                                                                      step="0.01" required
                                                                                      class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Stock *</label> <input th:field="*{stock}" type="number"
                                                                                     min="0" required
                                                                                     class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Categoría *</label> <select th:field="*{categoria}"
                                                                                          required
                                                                                          class="w-full border rounded px-3 py-2">
                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                </select></div>
                <div><label class="block text-sm font-medium">Proveedor *</label> <select th:field="*{proveedor}"
                                                                                          required
                                                                                          class="w-full border rounded px-3 py-2">
                    <option th:each="prov : ${proveedores}" th:value="${prov.id}" th:text="${prov.nombre}"></option>
                </select></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="btnCerrarRegistro" class="bg-gray-400 text-white px-3 py-1 rounded">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Editar -->
    <div id="modalEdicion" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-lg p-6"><h2 class="text-xl font-bold mb-4">Editar Producto</h2>
            <form id="formEditar" th:object="${producto}" method="post" class="space-y-4"><input type="hidden"
                                                                                                 th:name="${_csrf.parameterName}"
                                                                                                 th:value="${_csrf.token}"/>
                <input type="hidden" name="id" id="editId"/>
                <div><label class="block text-sm font-medium">Nombre *</label> <input name="nombre" id="editNombre"
                                                                                      type="text" maxlength="100"
                                                                                      required
                                                                                      class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Precio *</label> <input name="precio" id="editPrecio"
                                                                                      type="number" step="0.01" required
                                                                                      class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Stock *</label> <input name="stock" id="editStock"
                                                                                     type="number" min="0" required
                                                                                     class="w-full border rounded px-3 py-2"/>
                </div>
                <div><label class="block text-sm font-medium">Categoría *</label> <select name="categoria"
                                                                                          id="editCategoria" required
                                                                                          class="w-full border rounded px-3 py-2">
                    <option th:each="cat : ${categorias}" th:value="${cat}" th:text="${cat}"></option>
                </select></div>
                <div><label class="block text-sm font-medium">Proveedor *</label> <select name="proveedor"
                                                                                          id="editProveedor" required
                                                                                          class="w-full border rounded px-3 py-2">
                    <option th:each="prov : ${proveedores}" th:value="${prov.id}" th:text="${prov.nombre}"></option>
                </select></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="btnCerrarEdicion" class="bg-gray-400 text-white px-3 py-1 rounded">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!--Fin Modale-->

    <!-- Cards (mobile) -->
    <div class="md:hidden">
        <div class="overflow-y-auto max-h-[calc(100vh-100px)] space-y-4 p-2 pb-20">
            <div th:each="prod : ${productosPage.content}"
                 class="bg-white p-4 rounded-lg shadow flex flex-col gap-2 transition hover:shadow-md hover:scale-[1.01]">
                <div class="flex justify-between">
                    <h2 class="font-bold text-gray-800" th:text="${prod.nombre}">Producto</h2>
                    <span class="text-sm bg-blue-100 text-blue-600 px-2 py-1 rounded"
                          th:text="${prod.categoria}">Bebida</span>
                </div>
                <p><span class="font-semibold">Precio:</span> <span th:text="${prod.precio}">10.00</span></p>
                <p><span class="font-semibold">Stock:</span> <span th:text="${prod.stock}">100</span></p>
                <p><span class="font-semibold">Proveedor:</span> <span
                        th:text="${prod.proveedor.nombre}">Proveedor A</span></p>

                <div class="flex justify-end gap-2 pt-2">
                    <button class="btnEditar bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                            th:attr="data-id=${prod.id},
                                     data-nombre=${prod.nombre},
                                     data-precio=${prod.precio},
                                     data-stock=${prod.stock},
                                     data-categoria=${prod.categoria},
                                     data-proveedor=${prod.proveedor.id}">
                        Editar
                    </button>
                    <form th:action="@{/productos/eliminar/{id}(id=${prod.id})}" method="post"
                          class="inline eliminar-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                            Eliminar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginación sticky -->
    <div class=" md:hidden fixed bottom-0 left-0 w-full bg-white border-t py-3 flex justify-center space-x-2 shadow-md z-40">
        <a th:each="i : ${#numbers.sequence(0, productosPage.totalPages - 1)}"
           th:href="@{/productos(page=${i}, keyword=${keyword})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage}
               ? 'bg-blue-600 text-white px-3 py-1 rounded'
               : 'bg-gray-200 px-3 py-1 rounded hover:bg-gray-300'">
        </a>
    </div>


    <!-- Scripts -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const modalRegistro = document.getElementById('modalRegistro');
            const modalEdicion = document.getElementById('modalEdicion');
            const formEditar = document.getElementById('formEditar');

            // Abrir modal registro
            document.getElementById('btnNuevoProducto').addEventListener('click', () => {
                modalRegistro.classList.remove('hidden');
                modalRegistro.classList.add('flex');
            });

            // Cerrar modal registro
            document.getElementById('btnCerrarRegistro').addEventListener('click', () => {
                modalRegistro.classList.add('hidden');
                modalRegistro.classList.remove('flex');
            });

            // Editar
            document.querySelectorAll('.btnEditar').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = btn.getAttribute('data-id');
                    document.getElementById('editId').value = id;
                    document.getElementById('editNombre').value = btn.getAttribute('data-nombre') || '';
                    document.getElementById('editPrecio').value = btn.getAttribute('data-precio') || '';
                    document.getElementById('editStock').value = btn.getAttribute('data-stock') || '';
                    document.getElementById('editCategoria').value = btn.getAttribute('data-categoria') || '';
                    document.getElementById('editProveedor').value = btn.getAttribute('data-proveedor') || '';

                    formEditar.action = '/productos/actualizar/' + id;

                    modalEdicion.classList.remove('hidden');
                    modalEdicion.classList.add('flex');
                });
            });

            document.getElementById('btnCerrarEdicion').addEventListener('click', () => {
                modalEdicion.classList.add('hidden');
                modalEdicion.classList.remove('flex');
            });

            // Confirmación eliminar
            document.querySelectorAll('.eliminar-form').forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    Swal.fire({
                        title: '¿Eliminar producto?',
                        text: "No podrás deshacer esto",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, eliminar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#dc2626'
                    }).then(result => {
                        if (result.isConfirmed) form.submit();
                    });
                });
            });
        });
    </script>

</div>
</body>
</html>
