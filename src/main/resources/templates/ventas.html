<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="es"
      layout:decorate="~{layout}">

<head>
    <title>Ventas</title>
</head>
<body>
<div layout:fragment="contenido">

    <h1 class="text-3xl font-bold text-gray-800">Gestión de Ventas</h1>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div th:if="${success}">
        <script th:inline="javascript">
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: [[${success}]],
                confirmButtonColor: '#2563eb',
                heightAuto: false,
                scrollbarPadding: false
            });
        </script>
    </div>
    <div th:if="${error}">
        <script th:inline="javascript">
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: [[${error}]],
                confirmButtonColor: '#dc2626',
                heightAuto: false,
                scrollbarPadding: false
            });
        </script>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mt-6 mb-4 gap-4">
        <div class="w-full md:w-1/2">
            <form th:action="@{/ventas}" method="get" class="flex space-x-2">
                <input type="text" name="keyword" th:value="${keyword}"
                       placeholder="Buscar por cliente, usuario o producto"
                       class="w-full border rounded px-3 py-2"/>
                <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Buscar
                </button>
            </form>
        </div>

        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
            <form id="formExportarPDF" th:action="@{/ventas/exportar-pdf}" method="post" class="flex flex-col md:flex-row gap-2 items-center w-full">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="flex gap-2 w-full">
                    <input type="date" id="fechaInicio" name="fechaInicio" required
                           class="w-1/2 border rounded px-2 py-1"/>
                    <input type="date" id="fechaFin" name="fechaFin" required
                           class="w-1/2 border rounded px-2 py-1"/>
                </div>
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow w-full">
                    Exportar PDF
                </button>
            </form>

            <button id="btnNuevoVenta" type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow w-full">
                + Nueva Venta
            </button>
        </div>
    </div>


    <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto">
        <table class="min-w-full text-sm text-left">
            <thead class="bg-gray-100 text-gray-700 uppercase">
            <tr>
                <th class="px-4 py-3">ID</th>
                <th class="px-4 py-3">Cliente</th>
                <th class="px-4 py-3">Usuario</th>
                <th class="px-4 py-3">Producto</th>
                <th class="px-4 py-3">Cantidad</th>
                <th class="px-4 py-3">Total</th>
                <th class="px-4 py-3">Estado</th>
                <th class="px-4 py-3">Fecha</th>
                <th class="px-4 py-3 text-center">Acciones</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" th:each="venta : ${ventasPage.content}">
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3" th:text="${venta.id}">1</td>
                <td class="px-4 py-3" th:text="${venta.cliente?.nombre}">Cliente A</td>
                <td class="px-4 py-3" th:text="${venta.usuario?.email}">user@dominio</td>
                <td class="px-4 py-3" th:text="${venta.producto?.nombre}">Producto X</td>
                <td class="px-4 py-3" th:text="${venta.cantidad}">2</td>
                <td class="px-4 py-3" th:text="${venta.total}">20.00</td>
                <td class="px-4 py-3">
                    <span th:text="${venta.estado}"
                          class="px-2 py-1 rounded text-xs"
                          th:classappend="${venta.estado.name()} == 'PAGADA' ? 'bg-green-100 text-green-700' :
                      ((${venta.estado.name()} == 'PENDIENTE') ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700')">
                    </span>
                </td>
                <td class="px-4 py-3" th:text="${#temporals.format(venta.fechaVenta, 'dd/MM/yyyy HH:mm')}">01/01/2025</td>
                <td class="px-4 py-3 text-center space-x-2">
                    <button type="button"
                            class="btnEditar bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                            th:attr="data-id=${venta.id},
                                     data-cliente-id=${venta.cliente?.id},
                                     data-usuario-id=${venta.usuario?.id},
                                     data-producto-id=${venta.producto?.id},
                                     data-cantidad=${venta.cantidad},
                                     data-total=${venta.total},
                                     data-estado=${venta.estado}">
                        Editar
                    </button>

                    <form th:action="@{/ventas/eliminar/{id}(id=${venta.id})}" method="post"
                          class="inline eliminar-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit"
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                            Anular
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="hidden md:flex mt-4 justify-center space-x-2">
        <a th:each="i : ${#numbers.sequence(0, ventasPage.totalPages - 1)}"
           th:href="@{/ventas(page=${i}, keyword=${keyword})}"
           th:text="${i + 1}"
           th:classappend="${i == currentPage} ? 'bg-blue-600 text-white px-3 py-1 rounded' : 'bg-gray-200 px-3 py-1 rounded'">
        </a>
    </div>

    <div class="md:hidden">
        <div class="overflow-y-auto max-h-[calc(100vh-180px)] space-y-4 p-2 pb-20">
            <div th:each="venta : ${ventasPage.content}"
                 class="bg-white p-4 rounded-lg shadow flex flex-col gap-2 transition hover:shadow-md hover:scale-[1.01]">
                <div><span class="font-semibold">ID:</span> <span th:text="${venta.id}">1</span></div>
                <div><span class="font-semibold">Cliente:</span> <span th:text="${venta.cliente?.nombre}">Cliente A</span></div>
                <div><span class="font-semibold">Usuario:</span> <span th:text="${venta.usuario?.email}">user@dominio</span></div>
                <div><span class="font-semibold">Producto:</span> <span th:text="${venta.producto?.nombre}">Producto X</span></div>
                <div><span class="font-semibold">Cantidad:</span> <span th:text="${venta.cantidad}">2</span></div>
                <div><span class="font-semibold">Total:</span> <span th:text="${venta.total}">20.00</span></div>
                <div>
                    <span class="font-semibold">Estado:</span>
                    <span th:text="${venta.estado}"
                          class="ml-2 px-2 py-1 rounded text-xs"
                          th:classappend="${venta.estado.name()} == 'PAGADA' ? 'bg-green-100 text-green-700' :
                          ((${venta.estado.name()} == 'PENDIENTE') ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700')">
                    </span>
                </div>
                <div><span class="font-semibold">Fecha:</span> <span th:text="${#temporals.format(venta.fechaVenta, 'dd/MM/yyyy HH:mm')}">01/01/2025</span></div>
                <div class="flex flex-wrap gap-2 pt-2">
                    <button type="button"
                            class="btnEditar flex-1 min-w-[48%] bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm"
                            th:attr="data-id=${venta.id},
                                     data-cliente-id=${venta.cliente?.id},
                                     data-usuario-id=${venta.usuario?.id},
                                     data-producto-id=${venta.producto?.id},
                                     data-cantidad=${venta.cantidad},
                                     data-total=${venta.total},
                                     data-estado=${venta.estado}">
                        Editar
                    </button>
                    <form th:action="@{/ventas/eliminar/{id}(id=${venta.id})}" method="post"
                          class="flex-1 min-w-[48%] eliminar-form">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit"
                                class="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            Anular
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white shadow p-2 flex justify-center space-x-2">
            <a th:each="i : ${#numbers.sequence(0, ventasPage.totalPages - 1)}"
               th:href="@{/ventas(page=${i}, keyword=${keyword})}"
               th:text="${i + 1}"
               th:classappend="${i == currentPage}
                   ? 'bg-blue-600 text-white px-3 py-1 rounded'
                   : 'bg-gray-200 px-3 py-1 rounded hover:bg-gray-300'">
            </a>
        </div>
    </div>


    <div id="modalRegistro" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">Registrar Venta</h2>
            <form th:action="@{/ventas/registrar}" th:object="${nuevaVenta}" method="post" class="space-y-4">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div>
                    <label class="block text-sm font-medium">Cliente *</label>
                    <select th:field="*{cliente}" required class="w-full border rounded px-3 py-2">
                        <option value="">Seleccione cliente</option>
                        <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Producto *</label>
                    <select th:field="*{producto}" required class="w-full border rounded px-3 py-2">
                        <option value="">Seleccione producto</option>
                        <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}"></option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Cantidad *</label>
                    <input th:field="*{cantidad}" type="number" min="1" required class="w-full border rounded px-3 py-2"/>
                </div>

                <div>
                    <label class="block text-sm font-medium">Total *</label>
                    <input th:field="*{total}" type="number" step="0.01" min="0.01" required class="w-full border rounded px-3 py-2"/>
                </div>

                <div>
                    <label class="block text-sm font-medium">Estado *</label>
                    <select th:field="*{estado}" required class="w-full border rounded px-3 py-2">
                        <option th:each="e : ${estados}" th:value="${e}" th:text="${e}"></option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="btnCerrarRegistro" class="bg-gray-400 text-white px-3 py-1 rounded">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEdicion" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white w-full max-w-lg rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">Editar Venta</h2>
            <form id="formEditar" method="post" class="space-y-4">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="id" id="editId"/>

                <div>
                    <label class="block text-sm font-medium">Cliente *</label>
                    <select name="cliente.id" id="editClienteId" required class="w-full border rounded px-3 py-2">
                        <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Producto *</label>
                    <select name="producto.id" id="editProductoId" required class="w-full border rounded px-3 py-2">
                        <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}"></option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Cantidad *</label>
                    <input name="cantidad" id="editCantidad" type="number" min="1" required class="w-full border rounded px-3 py-2"/>
                </div>

                <div>
                    <label class="block text-sm font-medium">Total *</label>
                    <input name="total" id="editTotal" type="number" step="0.01" min="0.01" required class="w-full border rounded px-3 py-2"/>
                </div>

                <div>
                    <label class="block text-sm font-medium">Usuario *</label>
                    <select name="usuario.id" id="editUsuarioId" required class="w-full border rounded px-3 py-2">
                        <option th:each="u : ${usuarios}" th:value="${u.id}" th:text="${u.email}"></option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium">Estado *</label>
                    <select name="estado" id="editEstado" required class="w-full border rounded px-3 py-2">
                        <option th:each="e : ${estados}" th:value="${e}" th:text="${e}"></option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="btnCerrarEdicion" class="bg-gray-400 text-white px-3 py-1 rounded">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            const modalRegistro = document.getElementById('modalRegistro');
            const modalEdicion = document.getElementById('modalEdicion');
            const formEditar = document.getElementById('formEditar');

            // Abrir modal registro
            const btnNuevo = document.getElementById('btnNuevoVenta');
            if (btnNuevo) {
                btnNuevo.addEventListener('click', function () {
                    modalRegistro.classList.remove('hidden');
                    modalRegistro.classList.add('flex');
                });
            }

            // Cerrar modal registro
            const btnCerrarRegistro = document.getElementById('btnCerrarRegistro');
            if (btnCerrarRegistro) {
                btnCerrarRegistro.addEventListener('click', function () {
                    modalRegistro.classList.add('hidden');
                    modalRegistro.classList.remove('flex');
                });
            }

            // Editar: attach listeners a botones (data-attributes)
            document.querySelectorAll('.btnEditar').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = btn.getAttribute('data-id');
                    const clienteId = btn.getAttribute('data-cliente-id') || '';
                    const usuarioId = btn.getAttribute('data-usuario-id') || '';
                    const productoId = btn.getAttribute('data-producto-id') || '';
                    const cantidad = btn.getAttribute('data-cantidad') || '';
                    const total = btn.getAttribute('data-total') || '';
                    const estado = btn.getAttribute('data-estado') || '';

                    // Rellenar campos del modal edición
                    document.getElementById('editId').value = id;
                    document.getElementById('editClienteId').value = clienteId;
                    document.getElementById('editUsuarioId').value = usuarioId;
                    document.getElementById('editProductoId').value = productoId;
                    document.getElementById('editCantidad').value = cantidad;
                    document.getElementById('editTotal').value = total;
                    document.getElementById('editEstado').value = estado;

                    // Setear action con slash inicial
                    formEditar.action = '/ventas/actualizar/' + id;

                    // Abrir modal
                    modalEdicion.classList.remove('hidden');
                    modalEdicion.classList.add('flex');
                });
            });

            // cerrar edición
            const btnCerrarEdicion = document.getElementById('btnCerrarEdicion');
            if (btnCerrarEdicion) {
                btnCerrarEdicion.addEventListener('click', function () {
                    modalEdicion.classList.add('hidden');
                    modalEdicion.classList.remove('flex');
                });
            }

            // Confirmación anular (eliminar)
            document.querySelectorAll('.eliminar-form').forEach(form => {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    Swal.fire({
                        title: '¿Anular venta?',
                        text: "La venta quedará como anulada",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, anular',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#dc2626',
                        cancelButtonColor: '#6b7280',
                        heightAuto: false,
                        scrollbarPadding: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });

            // Reabrir modal registro si hay errores después de la redirección
            const hasErrors = [[${#fields.hasErrors('nuevaVenta.cantidad')}]] || [[${#fields.hasErrors('nuevaVenta.total')}]];
            if (hasErrors || [[${error != null}]]) {
                modalRegistro.classList.remove('hidden');
                modalRegistro.classList.add('flex');
            }


            const formExportar = document.getElementById('formExportarPDF');
            if (formExportar) {
                formExportar.addEventListener('submit', function (e) {
                    e.preventDefault(); // evitar submit normal

                    const inicio = document.getElementById('fechaInicio').value;
                    const fin = document.getElementById('fechaFin').value;

                    // Validaciones básicas
                    if (!inicio || !fin) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Campos requeridos',
                            text: 'Debes seleccionar ambas fechas.',
                            confirmButtonColor: '#2563eb',
                            heightAuto: false,
                            scrollbarPadding: false
                        });
                        return;
                    }

                    if (inicio > fin) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Rango inválido',
                            text: 'La fecha de inicio no puede ser mayor que la fecha fin.',
                            confirmButtonColor: '#dc2626',
                            heightAuto: false,
                            scrollbarPadding: false
                        });
                        return;
                    }

                    // ✅ Enviar con fetch
                    const formData = new FormData(formExportar);

                    fetch(formExportar.action, {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        if (response.status === 404) {
                            Swal.fire({
                                icon: 'info',
                                title: 'Sin resultados',
                                text: 'No se encontraron datos en el rango de fechas seleccionado.',
                                confirmButtonColor: '#2563eb',
                                heightAuto: false,
                                scrollbarPadding: false
                            });
                            return null;
                        }
                        if (!response.ok) {
                            throw new Error("Error en el servidor");
                        }

                        // 🔹 Obtener nombre de archivo desde Content-Disposition
                        const disposition = response.headers.get("Content-Disposition");
                        let fileName = "ventas.pdf"; // fallback
                        if (disposition && disposition.includes("filename=")) {
                            fileName = disposition
                                .split("filename=")[1]
                                .replace(/["']/g, ""); // limpia comillas
                        }

                        return response.blob().then(blob => ({ blob, fileName }));
                    }).then(data => {
                        if (data) {
                            const url = window.URL.createObjectURL(data.blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.fileName; // ✅ nombre real
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            window.URL.revokeObjectURL(url);
                        }
                    }).catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message,
                            confirmButtonColor: '#dc2626',
                            heightAuto: false,
                            scrollbarPadding: false
                        });
                    });
                });
            }
        });
        /*]]>*/
    </script>
</div>
</body>
</html>